<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - EasyMeal</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header class="topbar">
    <div class="brand">EasyMeal</div>
    <div class="top-actions">
       <span id="pointLabel" class="point-label hidden"></span>
       <span id="userLabel" class="user-label hidden"></span>
       <button class="btn small" onclick="goBackToMenu()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </header>

  <main class="wide-container">
    <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h2>
    
    <div id="summaryBox"></div>

    <div style="background: #fdfdfd; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-top: 20px;">
        <p style="margin:0; font-size:1.1rem;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <strong id="myPointDisplay" style="color:green">0</strong> ‡∏ö‡∏≤‡∏ó</p>
        <p style="margin:5px 0 20px 0; font-size:1.1rem;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong id="totalPayDisplay" style="color:red">0</strong> ‡∏ö‡∏≤‡∏ó</p>

        <button class="btn" id="payBtn" onclick="confirmPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô)</button>
        <div style="margin-top:10px">
            <a href="topup.html?from=payment" style="color: #B33939; text-decoration: underline; font-size: 0.9em;">‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠? ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</a>
        </div>
    </div>

  </main>

<script>
/* ----------------------------------------------------
   1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
---------------------------------------------------- */
const user = localStorage.getItem('user');
const userLabel = document.getElementById('userLabel');
const pointLabel = document.getElementById('pointLabel');
let currentPoints = 0;

if(user){
    userLabel.innerText = "User: " + user;
    userLabel.classList.remove('hidden');

    currentPoints = parseFloat(localStorage.getItem('userPoints') || '0');
    pointLabel.innerText = "‡πÄ‡∏á‡∏¥‡∏ô: " + currentPoints.toLocaleString() + " ‡∏ö.";
    pointLabel.classList.remove('hidden');
    
    document.getElementById('myPointDisplay').innerText = currentPoints.toLocaleString();
} else {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
    location.href = "login.html";
}
  
/* ----------------------------------------------------
   2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Draft)
---------------------------------------------------- */
const draft = JSON.parse(localStorage.getItem('orderDraft') || 'null');
if(!draft){
  alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π");
  location.href = "menu.html";
}

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏ô‡∏π
const menus = {
  somtum: { '‡∏ï‡∏≥‡πÑ‡∏ó‡∏¢': { price: 50 }, '‡∏ï‡∏≥‡∏õ‡∏π‡∏õ‡∏•‡∏≤‡∏£‡πâ‡∏≤': { price: 60 }, '‡∏Ñ‡∏≠‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≤‡∏á': { price: 70 }, '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß': { price: 10 } },
  tamsang: { '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö': { price: 55 }, '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö': { price: 50 }, '‡∏ú‡∏±‡∏î‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß‡∏´‡∏°‡∏π': { price: 55 }, '‡∏ú‡∏±‡∏î‡∏°‡∏≤‡∏°‡πà‡∏≤': { price: 50 }, '‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß': { price: 10 } },
  noodle: { '‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á': { price: 50 }, '‡πÄ‡∏¢‡πá‡∏ô‡∏ï‡∏≤‡πÇ‡∏ü': { price: 60 }, '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠': { price: 55 }, '‡πÄ‡∏Å‡∏≤‡πÄ‡∏´‡∏•‡∏≤': { price: 60 } },
  friedchicken: { '‡∏ô‡πà‡∏≠‡∏á‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î 2 ‡∏ä‡∏¥‡πâ‡∏ô': { price: 40 }, '‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà': { price: 55 }, '‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î': { price: 25 }, '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß': { price: 10 } },
  dessert: { '‡∏ö‡∏¥‡∏á‡∏ã‡∏π ‡∏ô‡∏°‡∏™‡∏î': { price: 70 }, '‡∏ö‡∏¥‡∏á‡∏ã‡∏π ‡πÇ‡∏≠‡∏ß‡∏±‡∏•‡∏ï‡∏¥‡∏ô': { price: 70 }, '‡∏ö‡∏¥‡∏á‡∏ã‡∏π ‡∏°‡∏±‡∏à‡∏â‡∏∞': { price: 70 }, '‡∏ö‡∏¥‡∏á‡∏ã‡∏π ‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà': { price: 70 } }
};

/* ----------------------------------------------------
   3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ (Render Summary)
---------------------------------------------------- */
let html = "<ul style='padding-left:20px; text-align:left;'>";
let totalAmount = 0;

draft.cart.forEach(it => {
  const item = menus[draft.shop][it.menuName];
  if (!item) return; 
  
  let special = it.special ? 10 : 0;
  let sum = (item.price + special) * it.qty;
  totalAmount += sum;

  let optText = it.takeAway ? "üì¶ ‡πÉ‡∏™‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á" : "üçΩÔ∏è ‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏ô";

  html += `<li style="margin-bottom:8px;">
    <strong>${it.menuName}</strong> ${it.special ? "(‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : ""} 
    <br><span style="color:#666; font-size:0.9em;">${optText}</span>
    x${it.qty} ‚Äî <span style="font-weight:bold">${sum}</span> ‡∏ö‡∏≤‡∏ó
  </li>`;
});
html += "</ul>";
html += `<hr style="margin:15px 0; border:0; border-top:1px dashed #ccc;">`;
html += `<p style="font-size:1.2rem;"><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong></p>`;

if(draft.note) {
    html += `<p style="color:red; background:#fff0f0; padding:10px; border-radius:5px;">
        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô: <i>${draft.note}</i>
    </p>`;
}

document.getElementById("summaryBox").innerHTML = html;
document.getElementById("totalPayDisplay").innerText = totalAmount.toLocaleString();

/* ----------------------------------------------------
   4. Functions
---------------------------------------------------- */
function goBackToMenu() {
    const lastShop = localStorage.getItem('currentShop') || 'somtum';
    location.href = 'menu.html?shop=' + lastShop;
}

function confirmPayment(){
  if(currentPoints < totalAmount){
      alert(`‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏Ç‡∏≤‡∏î ${totalAmount - currentPoints} ‡∏ö‡∏≤‡∏ó)\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö`);
      return;
  }

  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ${totalAmount} ‡∏ö‡∏≤‡∏ó?`)) return;

  const newBalance = currentPoints - totalAmount;
  localStorage.setItem('userPoints', newBalance);

  const uniqueID = "ORD-" + Math.floor(1000 + Math.random() * 9000);
  draft.orderID = uniqueID; 
  draft.paymentMethod = 'Wallet'; 
  
  localStorage.setItem('finishedOrder', JSON.stringify(draft));

  localStorage.removeItem('orderDraft');
  localStorage.removeItem('cart');
  
  alert(`‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${newBalance} ‡∏ö‡∏≤‡∏ó`);
  location.href = 'waiting.html'; 
}
</script>

</body>
</html>