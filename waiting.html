<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>รออาหาร - EasyMeal</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">EasyMeal</div>
    <div class="top-actions">
      <span id="userLabel" class="user-label hidden"></span>
      <button class="btn small" onclick="location.href='index.html'">หน้าหลัก</button>
    </div>
  </header>

  <main class="wide-container" style="text-align:center">
    <h2>สถานะคำสั่งซื้อ</h2>
    
    <div class="queueCard">
  <p>หมายเลขคิวของคุณคือ</p>
  
  <h1 id="queueNumber">A001</h1>

  <p id="waitText" style="font-size: 1.2rem;">เหลืออีก <span style="color:#B33939; font-weight:bold;">1</span> คิว</p>

  <p id="queueStatus" style="color:#e67e22; font-weight:bold;">กำลังเตรียมอาหาร...</p>
</div>

    <div style="margin-top: 20px; text-align: left; background: #fafafa; padding: 15px; border-radius: 10px; border: 1px solid #eee;">
      <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 8px;">ใบเสร็จรายการอาหาร</h3>
      
      <div id="receiptList"></div>
      
      <div style="margin-top:10px; border-top: 1px dashed #bbb; padding-top: 10px; display:flex; justify-content:space-between; font-weight:bold; font-size: 1.1em;">
        <span>รวมสุทธิ</span>
        <span><span id="receiptTotal">0</span> บาท</span>
      </div>
    </div>

    <div style="margin-top:20px">
      <button class="btn" onclick="location.href='index.html'">กลับหน้าหลัก</button>
    </div>
  </main>

<script>
/* ----------------------------------------------------
   1. ข้อมูลเมนูและราคา
---------------------------------------------------- */
const menus = {
  somtum: {
    'ตำไทย': { price: 50 }, 
    'ตำปูปลาร้า': { price: 60 }, 
    'คอหมูย่าง': { price: 70 }, 
    'ข้าวเหนียว': { price: 10 }
  },
  tamsang: {
    'ข้าวผัดกะเพราหมูกรอบ': { price: 55 }, 
    'ข้าวผัดหมูสับ': { price: 50 }, 
    'ผัดซีอิ๊วหมู': { price: 55 }, 
    'ผัดมาม่า': { price: 50 }, 
    'ไข่ดาว': { price: 10 }
  },
  noodle: {
    'บะหมี่น้ำหมูแดง': { price: 50 }, 
    'เย็นตาโฟ': { price: 60 }, 
    'ก๋วยเตี๋ยวเรือ': { price: 55 }, 
    'เกาเหลา': { price: 60 }
  },
  friedchicken: {
    'น่องไก่ทอด 2 ชิ้น': { price: 40 }, 
    'นักเก็ตไก่': { price: 55 }, 
    'ปีกไก่ทอด': { price: 25 },
    'ข้าวเหนียว': { price: 10 }
  },
  dessert: {
    'บิงซู นมสด': { price: 70 }, 
    'บิงซู โอวัลติน': { price: 70 }, 
    'บิงซู มัจฉะ': { price: 70 },
    'บิงซู สตรอเบอร์รี่': { price: 70 }
  }
};

/* ----------------------------------------------------
   2. แสดง User
---------------------------------------------------- */
const user = localStorage.getItem('user');
const userLabel = document.getElementById('userLabel');
if(user){
  userLabel.innerText = "User: " + user;
  userLabel.classList.remove('hidden');
}

/* ----------------------------------------------------
   3. ระบบคิว (Queue System) - แก้ใหม่ให้เริ่มที่ 1
---------------------------------------------------- */
const finishedOrder = JSON.parse(localStorage.getItem('finishedOrder') || 'null');
let myQueue = "";

// ตรวจสอบว่าออเดอร์นี้เคยได้คิวไปแล้วหรือยัง (กันกรณี User กด Refresh หน้าจอ)
if(finishedOrder && finishedOrder.queueNo) {
    // ถ้ามีแล้ว ให้ใช้เลขเดิม
    myQueue = finishedOrder.queueNo;
} else {
    // ถ้ายังไม่มี (เป็นรายการใหม่) ให้ดึงเลขลำดับล่าสุดจากระบบ
    // ถ้าไม่มีให้เริ่มที่ 0
    let currentQ = parseInt(localStorage.getItem('systemQueueRunning') || '0');
    
    // บวกเพิ่ม 1 (เพื่อให้เริ่มที่ 1, 2, 3...)
    currentQ++;
    
    // บันทึกค่าล่าสุดกลับลงเครื่อง
    localStorage.setItem('systemQueueRunning', currentQ);
    
    // จัดรูปแบบ A001, A002
    myQueue = "A" + String(currentQ).padStart(3, '0');
    
    // บันทึกเลขคิวลงในออเดอร์นี้ด้วย (เพื่อล็อคเลขไว้ ไม่ให้เปลี่ยนเวลารีเฟรช)
    if(finishedOrder) {
        finishedOrder.queueNo = myQueue;
        localStorage.setItem('finishedOrder', JSON.stringify(finishedOrder));
    }
}

document.getElementById('queueNumber').innerText = myQueue;

const receiptList = document.getElementById('receiptList');
const receiptTotal = document.getElementById('receiptTotal');

if(finishedOrder && finishedOrder.cart) {
  let html = '<ul style="padding-left: 20px; list-style: none; margin: 0;">';
  let totalMoney = 0;
  
  const shopName = finishedOrder.shop; 

  finishedOrder.cart.forEach(item => {

    const menuInfo = menus[shopName]?.[item.menuName];
    
    if(menuInfo) {
        let pricePerItem = menuInfo.price;
        if(item.special) pricePerItem += 10;
        
        let sumPrice = pricePerItem * item.qty;
        totalMoney += sumPrice;

        html += `
          <li style="display:flex; justify-content:space-between; margin-bottom:6px; border-bottom:1px solid #f0f0f0; padding-bottom:4px;">
            <span>
                ${item.menuName} ${item.special ? '(พิเศษ)' : ''} 
                <span style="color:#888; font-size:0.9em;">x${item.qty}</span>
            </span>
            <span>${sumPrice} บ.</span>
          </li>
        `;
    }
  });
  html += '</ul>';
  
  if(finishedOrder.note) {
    html += `<p style="color:red; font-size:0.9em; margin-top:8px;">*หมายเหตุ: ${finishedOrder.note}</p>`;
  }
  
  // แสดงรูปแบบการรับ
  let eatType = "";
  if(finishedOrder.eatHere) eatType = "ทานที่ร้าน";
  if(finishedOrder.takeAway) eatType = "กลับบ้าน";
  if(eatType) {
      html += `<p style="font-size:0.9em; color:#555; margin-top:5px;">รับสินค้า: ${eatType}</p>`;
  }

  receiptList.innerHTML = html;
  receiptTotal.innerText = totalMoney.toLocaleString();
  
} else {
  receiptList.innerHTML = '<p style="text-align:center; color:#999;">ไม่พบรายการคำสั่งซื้อล่าสุด</p>';
}

document.getElementById('queueNumber').innerText = "A001";

// 2. สั่งรอ 10 วินาที
setTimeout(() => {
  // ซ่อนข้อความ "เหลืออีก 1 คิว"
  document.getElementById('waitText').style.display = 'none';

  // เปลี่ยนสถานะเป็นเสร็จแล้ว
  const status = document.getElementById('queueStatus');
  status.innerText = 'อาหารเสร็จเรียบร้อย! เชิญรับที่เคาน์เตอร์';
  status.style.color = 'green';
  
  // เล่นเสียง
  new Audio('sound.mp3').play().catch(e=>{});

}, 10000); // 10000 ms = 10 วินาที

</script>
</body>
</html>